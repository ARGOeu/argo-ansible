---

- name: Install mongoDB packages
  tags: mongoDB-packages
  yum: name={{ item }} state=present
  with_items:
    - mongodb-org
    - mongodb-org-server

- name: check mongo version
  shell: rpm -q --queryformat '[%{RPMTAG_VERSION}]' mongodb-org
  ignore_errors: True
  register: mongo_version

- name: Bind mongod for version 3.0.0
  lineinfile: dest=/etc/mongod.conf
              regexp="^bind_ip = "
              line="bind_ip = 127.0.0.1,{{ ansible_eth0.ipv4.address }}"
              state=present
              backup=yes
  notify: restart mongo
  when: mongo_version is defined and mongo_version.stdout == "3.0.0"

- name: Bind mongod for version 3.0.7
  lineinfile: >
              dest=/etc/mongod.conf
              regexp="\ \ bindIp"
              line='  bindIp: {{ mongo_bind_interface }}'
              state=present
              backup=yes
  notify: restart mongo
  when: mongo_version is defined and mongo_version.stdout == "3.0.7"

- name: Fix issue with mongo init script in version 3.0.7
  lineinfile: >
              dest=/etc/mongod.conf
              regexp="\ \ pidFilePath"
              line='  pidFilePath: /var/run/mongodb/mongod.pid'
              state=present
              backup=yes
  notify: restart mongo
  when: mongo_version is defined and mongo_version.stdout == "3.0.7"

- name: Increase soft nproc limits
  copy: src=etc/security/limits.d/99-mongodb-nproc.conf
        dest=/etc/security/limits.d/99-mongodb-nproc.conf backup=no
        owner=root group=root mode=0644

- name: Enable and start mongoDB
  service: name=mongod enabled=yes state=started