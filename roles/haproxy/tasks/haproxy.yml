---
- name: install haproxy
  yum:
    name: haproxy
    state: present
  tags: haproxy

- name: create haproxy group
  group:
    name: haproxy
    state: present

- name: create haproxy user
  user:
    name: haproxy
    group: haproxy

- name: Change owner and group for x509 certificate
  file:
    path: "{{ cert_dir }}hostcert.pem"
    owner: haproxy
    group: haproxy

- name: Change owner and group for certificate key
  file:
    path: "{{ cert_dir }}hostkey.pem"
    owner: haproxy
    group: haproxy

- name: Bundle x509 crt and key in a single pem file
  tags: msg_certificate
  shell: cat {{ cert_dir }}hostcert.pem {{cert_dir}}hostkey.pem > {{cert_dir}}{{inventory_hostname}}.crt

- name: Change owner and group for bundled cert
  file:
    path: "{{cert_dir}}{{inventory_hostname}}.crt"
    owner: haproxy
    group: haproxy

- name: configure haproxy
  template:
    src: haproxy_template.cfg.j2
    dest: /etc/haproxy/haproxy.cfg
    backup: true

- name: configure haproxy log(rsyslog)
  template:
    src: rsyslog_haproxy.conf.j2
    dest: /etc/rsyslog.d/haproxy.conf
    backup: true
  notify: restart rsyslog

- name: start haproxy
  service:
    name: haproxy
    enabled: true
    state: started
