#!/bin/bash

# Path to the directory containing the tar files
directory="{{ kafka_logs }}/{{ kafka_monthly_archives_dir_name }}"

# Get the current date and calculate the date 6 months ago
current_date=$(date +%Y-%m-%d)
six_months_ago=$(date -d "6 months ago" +%Y-%m-%d)

# Loop through all tar files in the directory
for file in "$directory"/*.tar; do
  # Extract the name, year, and month from the filename using pattern matching
  if [[ $file =~ /([^/]+)\.([0-9]{4})-([0-9]{2})\.tar$ ]]; then
    name="${BASH_REMATCH[1]}"
    year="${BASH_REMATCH[2]}"
    month="${BASH_REMATCH[3]}"

    # Construct the full date from the year and month
    file_date="$year-$month-01"

    echo "Examining file: $file of $year-$month against: $six_months_ago"

    # Compare the file date with the date 6 months ago
    if [[ $file_date < $six_months_ago ]]; then
      echo "Removing $file"
      rm -f "$file"  # Remove the file forcefully
    fi
  fi
done
